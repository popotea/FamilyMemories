@model IEnumerable<FamilyMemories.Models.Memory>
@{
    ViewData["Title"] = "回憶管理";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">回憶管理</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-end">
                    <li class="breadcrumb-item"><a href="/Admin">首頁</a></li>
                    <li class="breadcrumb-item active">回憶管理</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<div class="content">
    <div class="container-fluid">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">所有回憶</h3>
                <div class="card-tools d-flex gap-2">
                    <a href="/Admin/Admin/CreateMemory" class="btn btn-success btn-sm" style="margin-right:8px;">
                        <i class="bi bi-plus"></i> 新增回憶
                    </a>
                    <button type="button" class="btn btn-danger btn-sm" id="batchDeleteBtn" disabled>
                        <i class="bi bi-trash"></i> 批次刪除
                    </button>
                    <div class="input-group input-group-sm" style="width: 200px;">
                        <input type="text" class="form-control" placeholder="搜尋..." id="searchInput">
                        <div class="input-group-append">
                            <button type="button" class="btn btn-default">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body table-responsive p-0">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th style="width:40px;"><input type="checkbox" id="selectAllMemories"></th>
                            <th style="width: 80px;">縮圖</th>
                            <th>標題</th>
                            <th>使用者</th>
                            <th>日期</th>
                            <th style="width: 100px;">操作</th>
                        </tr>
                    </thead>
                    <tbody id="memoriesTable">
                        @foreach (var memory in Model)
                        {
                            <tr data-id="@memory.Id">
                                <td><input type="checkbox" class="memory-checkbox" value="@memory.Id"></td>
                                <td>
                                    @{
                                        var r2Url = "https://c7d8f23f77d114bcc5e0b5c88c473255.r2.cloudflarestorage.com";
                                        var r2Bucket = "picture";
                                    }
                                    @if (!string.IsNullOrEmpty(memory.ImagePath))
                                    {
                                        <img src="@(memory.ImagePath.StartsWith("http", StringComparison.OrdinalIgnoreCase) ? memory.ImagePath : $"{r2Url}/{r2Bucket}/{memory.ImagePath}")" alt="@memory.Title" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;">
                                    }
                                    else
                                    {
                                        <span class="text-muted">圖片不存在</span>
                                    }
                                </td>
                                <td>
                                    <strong>@memory.Title</strong><br>
                                    <small class="text-muted">@memory.Description</small>
                                </td>
                                <td>@memory.ApplicationUser?.UserName</td>
                                <td>@memory.Date.ToString("yyyy-MM-dd")</td>
                                <td>
                                    <a href="/Admin/Admin/EditMemory/@memory.Id" class="btn btn-sm btn-primary" title="編輯">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button class="btn btn-sm btn-danger delete-btn" data-id="@memory.Id" title="刪除">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 刪除確認 Modal -->
<form id="deleteForm" method="post" asp-action="DeleteMemory">
    <input type="hidden" id="deleteMemoryId" name="id">
</form>

@section Scripts {
    <script src="~/js/admin/memories.js" asp-append-version="true"></script>
    <script>
        // 批次選取/刪除
        $(function(){
            $('#selectAllMemories').on('change', function(){
                $('.memory-checkbox').prop('checked', this.checked);
                $('#batchDeleteBtn').prop('disabled', !this.checked && $('.memory-checkbox:checked').length === 0);
            });
            $('.memory-checkbox').on('change', function(){
                var allChecked = $('.memory-checkbox').length === $('.memory-checkbox:checked').length;
                $('#selectAllMemories').prop('checked', allChecked);
                $('#batchDeleteBtn').prop('disabled', $('.memory-checkbox:checked').length === 0);
            });
            $('#batchDeleteBtn').on('click', function(){
                var ids = $('.memory-checkbox:checked').map(function(){ return $(this).val(); }).get();
                if(ids.length === 0) return;
                if(confirm('確定要刪除選取的回憶嗎？')){
                    $.ajax({
                        url: '/Admin/Admin/BatchDeleteMemories',
                        type: 'POST',
                        data: { ids: ids },
                        success: function(){ location.reload(); },
                        error: function(){ alert('批次刪除失敗'); }
                    });
                }
            });
        });
    </script>
}
