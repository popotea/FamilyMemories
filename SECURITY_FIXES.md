# 安全性修復與程式碼清理報告

## 修復日期
2025年1月

## 問題摘要
1. **未登入使用者可以看到編輯功能的 UI 元素**
2. **API 後端缺乏擁有者權限檢查**
3. **多餘的開發用程式碼未移除**
4. **未使用的 MVC Controller 檔案**

---

## 已修復的問題

### 1. 前端權限控制加強

#### 修改檔案: `Views/Home/Index.cshtml`
**修改內容：**
- ✅ 移除開發用的快速登入連結（位於頁面右下角）
- ✅ 編輯按鈕（modalEditBtn）現在只在已登入狀態下才會渲染到 HTML
- ✅ 新增回憶按鈕（addMemoryBtn）只在已登入狀態下顯示
- ✅ 編輯和新增 Modal 只在已登入狀態下才會渲染

**影響：**
未登入使用者將完全看不到任何編輯相關的 UI 元素。

---

#### 修改檔案: `wwwroot/js/home-gallery.js`
**修改內容：**
- ✅ 在初始化時，如果未登入會直接移除所有編輯相關的 DOM 元素
- ✅ 強化 `renderGallery()` 函數，只在使用者有權限時才顯示編輯按鈕
- ✅ 權限檢查邏輯：`isAuthenticated && (photo.userId === currentUserId || isAdmin)`
- ✅ 編輯 Modal、新增 Modal 的事件綁定只在已登入狀態下執行
- ✅ 在相片卡片點擊事件中增加權限檢查，防止未授權開啟編輯

**影響：**
前端 JavaScript 現在會嚴格檢查權限，即使有人試圖透過開發者工具操作，也無法觸發編輯功能。

---

### 2. 後端 API 權限強化

#### 修改檔案: `Controllers/Api/MemoriesController.cs`
**修改內容：**
- ✅ 注入 `UserManager<ApplicationUser>` 以便進行使用者身份驗證
- ✅ **GET 端點**（`GetMemories`, `GetMemory`）：標記為 `[AllowAnonymous]`，允許未登入使用者瀏覽，但會返回 UserId 和 Member 資訊供前端判斷
- ✅ **POST 端點**（`CreateMemory`）：
  - 需要 `[Authorize]`
  - 自動記錄當前使用者為記憶的擁有者（`ApplicationUserId`）
- ✅ **PUT 端點**（`UpdateMemory`）：
  - 需要 `[Authorize]`
  - **新增擁有者檢查**：只有記憶的擁有者或管理員可以編輯
  - 若非擁有者且非管理員，返回 `403 Forbid`
- ✅ **DELETE 端點**（`DeleteMemory`）：
  - 需要 `[Authorize]`
  - **新增擁有者檢查**：只有記憶的擁有者或管理員可以刪除
  - 若非擁有者且非管理員，返回 `403 Forbid`
  - 同時刪除實體圖片檔案
- ✅ **移除不安全的端點**：
  - 移除 `PATCH` 端點（允許部分更新但缺乏權限檢查）
  - 移除 `POST /batch` 批次更新端點（允許批次操作但缺乏逐筆權限檢查）
  - 移除 `POST /{id}/image` 單獨上傳圖片端點（功能重複且缺乏完整驗證）
- ✅ **DTO 更新**：在 `MemoryDto` 中增加 `UserId` 和 `Member` 欄位

**影響：**
後端現在會嚴格檢查每個操作的權限，即使繞過前端直接調用 API 也無法執行未授權的操作。

---

### 3. 移除多餘程式碼

#### 刪除檔案: `Controllers/MemoriesController.cs`
**原因：**
- 這是一個 MVC Controller，包含 Index、Create、Edit、Delete 等 Action
- 但專案已改用 API + AJAX 架構，前端直接調用 `/api/memories`
- 沒有任何對應的 Views（`Views/Memories/` 資料夾不存在）
- 保留此檔案會造成混淆和維護困難

**影響：**
專案結構更清晰，只保留實際使用的程式碼。

---

## 權限控制架構總結

### 前台（未登入使用者）
✅ **可以做：**
- 瀏覽首頁相簿（GET /api/memories）
- 查看回憶詳細資訊（GET /api/memories/{id}）
- 主題切換

❌ **不能做：**
- 新增回憶
- 編輯回憶
- 刪除回憶
- 看到任何編輯相關的 UI

### 前台（已登入一般使用者）
✅ **可以做：**
- 瀏覽所有回憶
- 新增自己的回憶
- **只能編輯自己的回憶**
- **只能刪除自己的回憶**
- 主題切換

❌ **不能做：**
- 編輯或刪除其他人的回憶
- 存取管理後台

### 前台（已登入管理員）
✅ **可以做：**
- 所有一般使用者的權限
- **編輯任何人的回憶**
- **刪除任何人的回憶**
- 存取管理後台

### 後台（管理員專用）
- 已有 `[Authorize(Roles = "Admin")]` 保護
- 只有管理員可以存取
- 可以管理使用者、角色、權限

---

## 測試建議

### 1. 未登入狀態測試
- [ ] 開啟首頁，確認可以看到相片瀏覽
- [ ] 確認**沒有**「新增回憶」按鈕
- [ ] 點擊任何相片，確認 Modal 中**沒有**「編輯」按鈕
- [ ] 確認相片卡片上**沒有**編輯圖示
- [ ] 打開開發者工具，確認 DOM 中不存在 `#addMemoryBtn` 和 `#modalEditBtn`

### 2. 一般使用者登入測試
- [ ] 登入後，確認可以看到「新增回憶」按鈕
- [ ] 點擊自己上傳的相片，確認 Modal 中有「編輯」按鈕
- [ ] 點擊其他人上傳的相片，確認 Modal 中**沒有**「編輯」按鈕
- [ ] 測試新增回憶功能
- [ ] 測試編輯自己的回憶
- [ ] 嘗試透過開發者工具手動調用 API 編輯別人的回憶，應該返回 403 Forbid

### 3. 管理員登入測試
- [ ] 確認所有相片的 Modal 中都有「編輯」按鈕
- [ ] 測試編輯任何使用者的回憶
- [ ] 測試刪除任何使用者的回憶
- [ ] 確認可以存取管理後台

### 4. API 直接測試（使用 Postman 或 curl）
```bash
# 測試未登入時無法新增
curl -X POST http://localhost:5000/api/memories \
  -F "title=Test" \
  -F "description=Test" \
  -F "date=2025-01-01" \
  -F "file=@test.jpg"
# 預期：401 Unauthorized

# 測試一般使用者無法編輯別人的回憶
# （需先登入取得 Cookie 或 Token）
curl -X PUT http://localhost:5000/api/memories/1 \
  -F "title=Hacked" \
  -F "description=Hacked" \
  -b cookies.txt
# 預期：403 Forbidden（如果 id=1 不是該使用者的回憶）
```

---

## 安全性檢查清單

- ✅ 前端 UI 完全隱藏未授權功能
- ✅ 前端 JavaScript 有權限檢查邏輯
- ✅ 後端 API 所有寫入操作都需要驗證
- ✅ 後端 API 有擁有者檢查（Owner-based Authorization）
- ✅ 管理員可以管理所有資源
- ✅ 檔案上傳有大小和類型驗證
- ✅ 刪除時會同步刪除實體檔案
- ✅ 無多餘或不安全的 API 端點
- ✅ 專案構建成功

---

## 注意事項

1. **Cookie-based 認證**：專案使用 ASP.NET Core Identity 的 Cookie 認證，前端 AJAX 請求會自動帶上 Cookie
2. **CSRF 保護**：API Controller 預設不需要防偽標記，但如果之後要加入表單提交，記得加上 `[ValidateAntiForgeryToken]`
3. **HTTPS**：生產環境務必啟用 HTTPS，保護 Cookie 和敏感資料傳輸
4. **日誌記錄**：建議在編輯/刪除操作中加入日誌記錄，追蹤誰修改了什麼

---

## 未來改進建議

1. **權限系統整合**：目前使用簡單的擁有者檢查，可以考慮整合已存在的 `Permission` 枚舉系統
2. **軟刪除**：考慮實作軟刪除（Soft Delete），讓管理員可以復原誤刪的回憶
3. **審計日誌**：記錄所有 CRUD 操作的使用者、時間、IP 等資訊
4. **速率限制**：對 API 端點加入速率限制，防止濫用
5. **圖片處理**：上傳時自動產生縮圖，優化載入速度

---

## 結論

✅ **前後端權限控制已全面強化**  
✅ **未登入使用者無法執行任何編輯操作**  
✅ **一般使用者只能編輯自己的內容**  
✅ **管理員可以管理所有內容**  
✅ **多餘程式碼已移除**  
✅ **專案構建成功**

所有修改已完成，專案現在具有完整的權限控制機制。
